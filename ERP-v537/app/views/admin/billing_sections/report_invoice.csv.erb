<%- headers = ["Order Number", "Invoice Number", "Invoice Amount", "Quote", "Invoice Difference", "Carrier", "Status", "Dispute Reason"] -%>
<%= CSV.generate_line headers -%>
<%- @records.each do |record| -%>
  <%- if record.white_glove -%>
    <%- @invoice = record.shipping_detail.invoice_for_wgd || record.shipping_detail.create_invoice_for_wgd -%>
  <%- else -%>
    <%- @invoice = record.shipping_detail.invoice_for_billing || record.shipping_detail.create_invoice_for_billing -%>
  <%- end -%>
<%= CSV.generate_line([ record.order.name, @invoice.invoice_number, @invoice.invoice_amount.to_f, (record.white_glove ? record&.shipping_detail&.white_glove_fee.to_f : record&.shipping_detail&.actual_invoiced.to_f), (posting.white_glove ? number_to_currency(posting&.shipping_detail&.white_glove_fee.to_f - @invoice.invoice_amount.to_f) : number_to_currency(posting&.shipping_detail&.actual_invoiced.to_f - @invoice.invoice_amount.to_f)), (record.white_glove ? record&.shipping_detail&.white_glove_address&.company : record&.shipping_detail&.carrier&.name), record.status&.humanize, record&.reason ]) -%>
<%- end -%>





<%= CSV.generate_line(["Total Invoice Amount", @records.sum { |record| record.white_glove ? record.shipping_detail.invoice_for_wgd.invoice_amount.to_f : record.shipping_detail.invoice_for_billing.invoice_amount.to_f }]) %><%= CSV.generate_line(["Total Orders", @records.joins(:order).group("orders.id").count.length]) %><%= CSV.generate_line(["Total Paid", @records.where(status: "paid").uniq.count]) %><%= CSV.generate_line(["Total Dispute",  @records.where(status: "dispute").uniq.count]) %>