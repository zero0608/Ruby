<%- headers = ["Order Number", "Carrier", "Broker", "Invoice Number", "Invoice Date", "Due Date", "Tax Type", "Tax", "Invoice Amount", "status", "Dispute Reason"] -%>
<%= CSV.generate_line headers -%>
<%- @selected_postings.each do |posting| -%>
  <%- if posting&.shipping_detail_id.present? -%>
    <%- invoice = posting&.white_glove ? posting&.shipping_detail.invoice_for_wgd : posting&.shipping_detail.invoice_for_billing -%>
  <%- elsif posting&.return_id.present? -%>
    <%- invoice = posting&.white_glove ? posting&.return.invoice_for_wgd : posting&.return.invoice_for_billing -%>
  <%- elsif posting&.consolidation_id.present? -%>
    <%- invoice = posting&.white_glove ? posting&.consolidation.invoice_for_wgd : posting&.consolidation.invoice_for_billing -%>
  <%- end -%>
<%= CSV.generate_line([(posting&.order_id.present? ? (posting&.order&.name) : (posting&.return_id.present? ? ((posting&.return&.customer_return ? "CRT-" : "RT-") + posting&.return&.order&.name + "-" + (posting&.return&.order&.returns.where(customer_return: posting&.return&.customer_return).index(posting&.return) + 1).to_s.rjust(2, "0")) : (posting&.consolidation.name ))), (posting&.order_id.present? ? (posting.white_glove ? posting&.shipping_detail&.white_glove_address&.company : posting&.shipping_detail&.shipping_quotes&.find_by(selected: true)&.carrier&.name) : (posting&.return_id.present? ? (posting.white_glove ? (posting&.return&.white_glove_address if posting&.return.white_glove_address.present?) : posting&.return&.carrier&.name) : (posting.white_glove ? posting&.consolidation.shipping_details.first&.white_glove_address&.company : posting&.consolidation.shipping_details.first&.shipping_quotes&.find_by(selected: true)&.carrier&.name))), (posting&.order_id.present? ? (posting&.shipping_detail&.shipping_quotes&.find_by(selected: true)&.truck_broker&.name unless posting.white_glove) : (posting&.return_id.present? ? (posting&.return&.carrier&.truck_broker&.name unless posting.white_glove) : (posting&.consolidation.shipping_details.first&.shipping_quotes&.find_by(selected: true)&.truck_broker&.name unless posting.white_glove))), invoice&.invoice_number, invoice&.invoice_date, invoice&.invoice_due_date, (posting&.store == "us" ? "Tax" : ((invoice&.tax.present? ? "GST/HST" : "") + (invoice&.qst.present? ? " QST" : ""))), invoice&.tax.to_f + invoice&.qst.to_f, invoice&.invoice_amount.to_f, posting&.status, posting&.dispute_not_paid_reason]) -%>
<%- end -%>