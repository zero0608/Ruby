<div class="table-responsive flex-auto">
  <table class="table table-borderless table-hover">
    <thead>
      <tr>
        <th style="width: 10%">Order ID</th>
        <th style="width: 5%">Invoice Number</th>
        <th style="width: 10%">Invoice Amount</th>
        <th style="width: 10%">Invoice Date</th>
        <th style="width: 8%">Invoice Due Date</th>
        <th style="width: 7%">Invoice Difference</th>
        <th style="width: 8%">Broker</th>
        <th style="width: 10%">Carrier</th>
        <th style="width: 7%">Carrier Quote</th>
        <th style="width: 5%">Posted</th>
        <th style="width: 5%">Status</th>
        <th style="width: 10%">Action</th>
      </tr>
    </thead>
    <tbody>
      <% @records.each do |record| %>
        <% if record.order_id.present? %>
          <% order = record.order %>
          <% if record.white_glove %>
            <% @invoice = record.shipping_detail.invoice_for_wgd || record.shipping_detail.create_invoice_for_wgd %>
          <% else %>
            <% @invoice = record.shipping_detail.invoice_for_billing || record.shipping_detail.create_invoice_for_billing %>
          <% end %>
          <tr>
            <td><%= link_to record.order.name, edit_admin_order_path(record.order) %></td>
            <td><%= @invoice.invoice_number %></td>
            <td><%= number_to_currency(@invoice.invoice_amount.to_f) %></td>
            <td><%= @invoice.invoice_date&.strftime("%B %d, %Y") %></td>
            <td><%= @invoice.invoice_due_date&.strftime("%B %d, %Y") %></td>
            <td>
              <% if record.white_glove %>
                <%= number_to_currency(record&.shipping_detail&.white_glove_fee.to_f - @invoice.invoice_amount.to_f) %>
              <% else %>
                <%= number_to_currency(record&.shipping_detail&.actual_invoiced.to_f - @invoice.invoice_amount.to_f) %>
              <% end %>
            </td>
            <td><%= record&.shipping_detail&.shipping_quotes&.find_by(selected: true)&.truck_broker&.name unless record.white_glove %></td>
            <td>
              <% if record.white_glove %>
                <%= record&.shipping_detail&.white_glove_directory&.company_name %>
              <% else %>
                <%= record&.shipping_detail&.shipping_quotes&.find_by(selected: true)&.carrier&.name %>
              <% end %>
            </td>
            <td>
              <% if record.white_glove %>
                <%= number_to_currency(record&.shipping_detail&.white_glove_fee.to_f) %>
              <% else %>
                <%= number_to_currency(record&.shipping_detail&.actual_invoiced.to_f) %>
              <% end %>
            </td>
            <td>
              <input id="<%= "record-" + record.id.to_s %>" type="checkbox" data-switch="blue" data-id="<%= record.id %>" data-current_store="<%= current_store %>" data-reflex="change->BillingSectionReflex#record_post" <%= "checked" if record.posted %>>
              <label for="<%= "record-" + record.id.to_s %>">&nbsp;</label>
            </td>
            <td>
              <% if record.status.present? %>
                <span class="badge badge-outline-grey">
                  <%= record.status.humanize %>
                </span>
              <% end %>
            </td>
            <td>
              <%= link_to "", records_admin_billing_sections_path(result: "undo", record_id: record.id), class: "btn btn-primary uil-redo", style: "min-width: initial" %>
              <div class="toggle-view border-blue float-right rounded-circle rounded-circle-2" data-toggle="<%= record.id %>" style="top: 3px">
                <span class="dripicons-plus text-blue" style="top: 45%"></span>
              </div>
            </td>
          </tr>
          <tr class="toggle-content" data-toggle="<%= record.id %>">
            <td colspan=11>
              <div class="row no-gutters">
                <div class="col-8">
                  <%= form_for(@invoice, url: upload_doc_admin_billing_sections_path(order_id: record.order_id, invoice: "yes", section: "record", invoice_id: @invoice.id, invoice_type: record.invoice_type), method: :post, html: { id: "upload_doc_" + @invoice.id.to_s, class: "form-horizontal form-bordered" }) do |f| %>
                    <div class="row">
                      <div class="col-6" style="boarder-right: solid 1px var(--black)">
                        <div class="row">
                          <div class="col-6" style="height: 7.5rem; overflow-x: hidden; overflow-y: auto">
                            <label>Customer Name</label>
                            <p><%= order.customer.full_name %></p>
                          </div>
                          <div class="col-6" style="height: 7.5rem; overflow-x: hidden; overflow-y: auto">
                            <label>Shipped Date</label>
                            <p><%= record&.shipping_detail&.shipped_date&.strftime("%B %d, %Y") %></p>
                          </div>
                          <div class="col-6" style="height: 7.5rem; overflow-x: hidden; overflow-y: auto">
                            <label>Amount</label>
                            <p>
                              <%= number_to_currency((order&.line_items.pluck(:price).reject(&:blank?).map(&:to_i).zip(order&.line_items.pluck(:quantity).reject(&:blank?).map(&:to_i)).map{|x, y| x * y}).sum) %>
                            </p>
                          </div>
                          <div class="col-6" style="height: 7.5rem; overflow-x: hidden; overflow-y: auto">
                            <label>Shipping Method</label>
                            <p><%= order&.shipping_line&.title %></p>
                          </div>
                        </div>
                      </div>

                      <div class="col-6" style="border-right: solid 1px var(--black)">
                        <div class="row">
                          <div class="col-12" style="height: 7.5rem; overflow-x: hidden; overflow-y: auto">
                            <label>Order Date</label>
                            <p><%= order.created_at&.strftime("%B %d, %Y") %></p>
                          </div>
                          <div class="col-6" style="height: 7.5rem; overflow-x: hidden; overflow-y: auto">
                            <div class="file-input-container">
                              <label class="mr-2">Invoice Document</label>
                              <%= f.file_field :files, multiple: true, class: "file-temp d-none", accept: ".pdf, .jpeg, .jpg, .png" %>
                              <a class="file-input">Upload</a>
                            </div>
                            <div class="file-name"></div>
                            <% @invoice.files.each do |doc| %>
                              <% if doc.created_at? %>
                                <%= link_to doc.filename, doc, target: :_blank %>
                                <%= link_to delete_upload_admin_billing_sections_path(doc_id: doc), class: "ml-2", method: :delete, data: { confirm: "Are you sure you want to delete this file?" } do %>
                                  <%= show_svg("close.svg") %>
                                <% end %><br>
                              <% end %>
                            <% end %>
                          </div>
                          <div class="col-6" style="height: 7.5rem; overflow-x: hidden; overflow-y: auto">
                            <label>Bill of Lading</label>
                            <% if record&.shipping_detail&.files.present? %>
                              <% record&.shipping_detail&.files.each do |doc| %>
                                <% if doc.created_at? %>
                                  <br><%= link_to doc.filename, doc, target: :_blank %>
                                  <%= link_to delete_upload_admin_billing_sections_path(doc_id: doc), class: "ml-2", method: :delete, data: { confirm: "Are you sure you want to delete this file?" } do %>
                                    <%= show_svg("close.svg") %>
                                  <% end %>
                                <% end %>
                              <% end %>
                            <% end %>
                          </div>
                        </div>
                      </div>
                      
                      <div class="col-12">
                        <%= f.submit "Submit", class: "btn btn-primary" %>
                      </div>
                    </div>
                  <% end %>
                </div>
                    
                <div class="col-4 pl-3">
                  <label class="pl-3">Updates</label>
                  <div class="timeline-container">
                    <div class="row mx-0 timeline timeline-line">
                      <% order.associated_audits.order(created_at: :desc).each do |audit| %>
                        <% if audit.auditable_type == "Comment" && audit.audited_changes %>
                          <% if audit.audited_changes["description"]&.start_with?("Shipping invoice") %>
                            <div class="col-2 mb-5">
                              <%= render partial: "/admin/comments/timeline_icon" %>
                            </div>
                            <div class="col-10 mb-5">
                              <%= render partial: "/admin/comments/timeline_date", locals: { audit: audit } %>
                              <p><%= audit.audited_changes["description"]&.html_safe if audit.audited_changes["description"].present? %></p>
                            </div>
                          <% end %>
                        <% end %>
                      <% end %>
                    </div>
                  </div>
                </div>
              </div>
            </td>
          </tr>
        <% elsif record.return_id.present? %>
          <% re = record.return %>
          <% if record.white_glove %>
            <% @invoice = re.invoice_for_wgd || re.create_invoice_for_wgd %>
          <% else %>
            <% @invoice = re.invoice_for_billing || re.create_invoice_for_billing %>
          <% end %>
          <tr>
            <td>
              <%= link_to (re.customer_return ? "CRT-" : "RT-") + re.order.name + "-" + (re.order.returns.where(customer_return: re.customer_return).order(created_at: :desc).index(re) + 1).to_s.rjust(2, "0"), edit_admin_return_path(re.id) %>
            </td>
            <td><%= @invoice.invoice_number %></td>
            <td><%= number_to_currency(@invoice.invoice_amount.to_f) %></td>
            <td><%= @invoice.invoice_date&.strftime("%B %d, %Y") %></td>
            <td><%= @invoice.invoice_due_date&.strftime("%B %d, %Y") %></td>
            <td><%= number_to_currency(re.shipping_cost.to_f - @invoice.invoice_amount.to_f) %></td>
            <td><%= re&.carrier&.truck_broker&.name unless record.white_glove %></td>
            <td>
              <% if record.white_glove %>
                <%= re&.white_glove_directory&.company_name if re.white_glove_directory.present? %>
              <% else %>
                <%= re&.carrier&.name %>
              <% end %>
            </td>
            <td><%= number_to_currency(re.shipping_cost.to_f) %></td>
            <td>
              <input id="<%= "record-" + record.id.to_s %>" type="checkbox" data-switch="blue" data-id="<%= record.id %>" data-current_store="<%= current_store %>" data-reflex="change->BillingSectionReflex#record_post" <%= "checked" if record.posted %>>
              <label for="<%= "record-" + record.id.to_s %>">&nbsp;</label>
            </td>
            <td>
              <% if record.status.present? %>
                <span class="badge badge-outline-grey">
                  <%= record.status.humanize %>
                </span>
              <% end %>
            </td>
            <td>
              <%= link_to "", records_admin_billing_sections_path(result: "undo", record_id: record.id), class: "btn btn-primary uil-redo", style: "min-width: initial" %>
              <div class="toggle-view border-blue float-right rounded-circle rounded-circle-2" data-toggle="<%= record.id %>" style="top: 3px">
                <span class="dripicons-plus text-blue" style="top: 45%"></span>
              </div>
            </td>
          </tr>
          <tr class="toggle-content" data-toggle="<%= record.id %>">
            <td colspan=11>
              <div class="row no-gutters">
                <div class="col-8">
                  <%= form_for(@invoice, url: upload_doc_admin_billing_sections_path(return_id: record.return_id, invoice: "yes", section: "record", invoice_id: @invoice.id, invoice_type: record.invoice_type), method: :post, html: { id: "upload_doc_" + @invoice.id.to_s, class: "form-horizontal form-bordered" }) do |f| %>
                    <div class="row">
                      <div class="col-6" style="boarder-right: solid 1px var(--black)">
                        <div class="row">
                          <div class="col-6" style="height: 7.5rem; overflow-x: hidden; overflow-y: auto">
                            <label>Customer Name</label>
                            <p><%= re.order.customer.full_name %></p>
                          </div>
                          <div class="col-6" style="height: 7.5rem; overflow-x: hidden; overflow-y: auto">
                            <label>Shipped Date</label>
                            <p><%= re.return_date %></p>
                          </div>
                          <div class="col-6" style="height: 7.5rem; overflow-x: hidden; overflow-y: auto">
                            <label>Amount</label>
                            <p><%= number_to_currency(re.return_quote.to_f) %></p>
                          </div>
                          <div class="col-6" style="height: 7.5rem; overflow-x: hidden; overflow-y: auto">
                            <label>Shipping Method</label>
                            <p><%= re.white_glove_address.present? ? "White Glove Delivery" : "Curbside Delivery" %></p>
                          </div>
                        </div>
                      </div>

                      <div class="col-6" style="border-right: solid 1px var(--black)">
                        <div class="row">
                          <div class="col-12" style="height: 7.5rem; overflow-x: hidden; overflow-y: auto">
                            <label>Order Date</label>
                            <p><%= re.created_at&.strftime("%B %d, %Y") %></p>
                          </div>
                          <div class="col-6" style="height: 7.5rem; overflow-x: hidden; overflow-y: auto">
                            <div class="file-input-container">
                              <label class="mr-2">Invoice Document</label>
                              <%= f.file_field :files, multiple: true, class: "file-temp d-none", accept: ".pdf, .jpeg, .jpg, .png" %>
                              <a class="file-input">Upload</a>
                            </div>
                            <div class="file-name"></div>
                            <% @invoice.files.each do |doc| %>
                              <% if doc.created_at? %>
                                <%= link_to doc.filename, doc, target: :_blank %>
                                <%= link_to delete_upload_admin_billing_sections_path(doc_id: doc), class: "ml-2", method: :delete, data: { confirm: "Are you sure you want to delete this file?" } do %>
                                  <%= show_svg("close.svg") %>
                                <% end %><br>
                              <% end %>
                            <% end %>
                          </div>
                          <div class="col-6" style="height: 7.5rem; overflow-x: hidden; overflow-y: auto">
                            <label>Bill of Lading</label>
                            <% if re&.files.present? %>
                              <% re&.files.each do |doc| %>
                                <% if doc.created_at? %>
                                  <br><%= link_to doc.filename, doc, target: :_blank %>
                                  <%= link_to delete_upload_admin_billing_sections_path(doc_id: doc), class: "ml-2", method: :delete, data: { confirm: "Are you sure you want to delete this file?" } do %>
                                    <%= show_svg("close.svg") %>
                                  <% end %>
                                <% end %>
                              <% end %>
                            <% end %>
                          </div>
                        </div>
                      </div>
                      
                      <div class="col-12">
                        <%= f.submit "Submit", class: "btn btn-primary" %>
                      </div>
                    </div>
                  <% end %>
                </div>
                      
                <div class="col-4 pl-3">
                  <label class="pl-3">Updates</label>
                  <div class="timeline-container">
                    <div class="row mx-0 timeline timeline-line">
                      <% re.associated_audits.order(created_at: :desc).each do |audit| %>
                        <% if audit.auditable_type == "Comment" && audit.audited_changes %>
                          <% if audit.audited_changes["description"]&.start_with?("Shipping invoice") %>
                            <div class="col-2 mb-5">
                              <%= render partial: "/admin/comments/timeline_icon" %>
                            </div>
                            <div class="col-10 mb-5">
                              <%= render partial: "/admin/comments/timeline_date", locals: { audit: audit } %>
                              <p><%= audit.audited_changes["description"]&.html_safe if audit.audited_changes["description"].present? %></p>
                            </div>
                          <% end %>
                        <% end %>
                      <% end %>
                    </div>
                  </div>
                </div>
              </div>
            </td>
          </tr>
          
        <% elsif record.consolidation_id.present? %>
          <% consolidation = record.consolidation %>
          <% if record.white_glove %>
            <% @invoice = consolidation.invoice_for_wgd || consolidation.create_invoice_for_wgd %>
          <% else %>
            <% @invoice = consolidation.invoice_for_billing || consolidation.create_invoice_for_billing %>
          <% end %>
          <tr>
            <td><%= consolidation.name %></td>
            <td><%= @invoice.invoice_number %></td>
            <td><%= number_to_currency(@invoice.invoice_amount.to_f) %></td>
            <td><%= @invoice.invoice_date&.strftime("%B %d, %Y") %></td>
            <td><%= @invoice.invoice_due_date&.strftime("%B %d, %Y") %></td>
            <td>
              <% if record.white_glove %>
                <p><%= number_to_currency(consolidation.shipping_details.sum { |sd| sd.white_glove_fee.to_f } - @invoice.invoice_amount.to_f) %></p>
              <% else %>
                <p><%= number_to_currency(consolidation.shipping_details.sum { |sd| sd.actual_invoiced.to_f } - @invoice.invoice_amount.to_f) %></p>
              <% end %>
            </td>
            <td><%= consolidation.shipping_details.first&.shipping_quotes&.find_by(selected: true)&.truck_broker&.name unless record.white_glove %></td>
            <td>
              <% if record.white_glove %>
                <%= consolidation.shipping_details.first&.white_glove_directory&.company_name %>
              <% else %>
                <%= consolidation.shipping_details.first&.shipping_quotes&.find_by(selected: true)&.carrier&.name %>
              <% end %>
            </td>
            <td>
              <% if record.white_glove %>
                <%= number_to_currency(consolidation.shipping_details.sum { |sd| sd.white_glove_fee.to_f }) %>
              <% else %>
                <%= number_to_currency(consolidation.shipping_details.sum { |sd| sd.actual_invoiced.to_f }) %>
              <% end %>
            </td>
            <td>
              <input id="<%= "record-" + record.id.to_s %>" type="checkbox" data-switch="blue" data-id="<%= record.id %>" data-current_store="<%= current_store %>" data-reflex="change->BillingSectionReflex#record_post" <%= "checked" if record.posted %>>
              <label for="<%= "record-" + record.id.to_s %>">&nbsp;</label>
            </td>
            <td>
              <% if record.status.present? %>
                <span class="badge badge-outline-grey">
                  <%= record.status.humanize %>
                </span>
              <% end %>
            </td>
            <td>
              <%= link_to "", records_admin_billing_sections_path(result: "undo", record_id: record.id), class: "btn btn-primary uil-redo", style: "min-width: initial" %>
              <div class="toggle-view border-blue float-right rounded-circle rounded-circle-2" data-toggle="<%= record.id %>" style="top: 3px">
                <span class="dripicons-plus text-blue" style="top: 45%"></span>
              </div>
            </td>
          </tr>
          <tr class="toggle-content" data-toggle="<%= record.id %>">
            <td colspan=11>
              <div class="row no-gutters">
                <div class="col-8">
                  <%= form_for(@invoice, url: upload_doc_admin_billing_sections_path(consolidation_id: record.consolidation_id, invoice: "yes", section: "record", invoice_id: @invoice.id, invoice_type: record.invoice_type), method: :post, html: { id: "upload_doc_" + @invoice.id.to_s, class: "form-horizontal form-bordered row no-gutters" }) do |f| %>
                    <div class="row">
                      <div class="col-6" style="boarder-right: solid 1px var(--black)">
                        <div class="row">
                          <div class="col-6" style="height: 7.5rem; overflow-x: hidden; overflow-y: auto">
                            <label>Customer Name</label>
                            <p></p>
                          </div>
                          <div class="col-6" style="height: 7.5rem; overflow-x: hidden; overflow-y: auto">
                            <label>Shipped Date</label>
                            <p></p>
                          </div>
                          <div class="col-6" style="height: 7.5rem; overflow-x: hidden; overflow-y: auto">
                            <label>Amount</label>
                            <p></p>
                          </div>
                          <div class="col-6" style="height: 7.5rem; overflow-x: hidden; overflow-y: auto">
                            <label>Shipping Method</label>
                            <p>Consolidated</p>
                          </div>
                        </div>
                      </div>

                      <div class="col-6" style="border-right: solid 1px var(--black)">
                        <div class="row">
                          <div class="col-12" style="height: 7.5rem; overflow-x: hidden; overflow-y: auto">
                            <label>Order Date</label>
                            <p></p>
                          </div>
                          <div class="col-6" style="height: 7.5rem; overflow-x: hidden; overflow-y: auto">
                            <div class="file-input-container">
                              <label class="mr-2">Invoice Document</label>
                              <%= f.file_field :files, multiple: true, class: "file-temp d-none", accept: ".pdf, .jpeg, .jpg, .png" %>
                              <a class="file-input">Upload</a>
                            </div>
                            <div class="file-name"></div>
                            <% @invoice.files.each do |doc| %>
                              <% if doc.created_at? %>
                                <%= link_to doc.filename, doc, target: :_blank %>
                                <%= link_to delete_upload_admin_billing_sections_path(doc_id: doc), class: "ml-2", method: :delete, data: { confirm: "Are you sure you want to delete this file?" } do %>
                                  <%= show_svg("close.svg") %>
                                <% end %><br>
                              <% end %>
                            <% end %>
                          </div>
                          <div class="col-6" style="height: 7.5rem; overflow-x: hidden; overflow-y: auto">
                            <label>Bill of Lading</label>
                            <% if consolidation.shipping_details.first&.files.present? %>
                              <% consolidation.shipping_details.first&.files.each do |doc| %>
                                <% if doc.created_at? %>
                                  <br><%= link_to doc.filename, doc, target: :_blank %>
                                  <%= link_to delete_upload_admin_billing_sections_path(doc_id: doc), class: "ml-2", method: :delete, data: { confirm: "Are you sure you want to delete this file?" } do %>
                                    <%= show_svg("close.svg") %>
                                  <% end %>
                                <% end %>
                              <% end %>
                            <% end %>
                          </div>
                        </div>
                      </div>

                      <div class="col-12">
                        <%= f.submit "Submit", class: "btn btn-primary" %>
                      </div>
                    </div>
                  <% end %>
                </div>
                      
                <div class="col-4 pl-3">
                  <label class="pl-3">Updates</label>
                  <div class="timeline-container">
                    <div class="row mx-0 timeline timeline-line">
                      <% consolidation.own_and_associated_audits.order(created_at: :desc).each do |audit| %>
                        <% if audit.auditable_type == "Comment" && audit.audited_changes %>
                          <% if audit.audited_changes["description"]&.start_with?("Shipping invoice") %>
                            <div class="col-2 mb-5">
                              <%= render partial: "/admin/comments/timeline_icon" %>
                            </div>
                            <div class="col-10 mb-5">
                              <%= render partial: "/admin/comments/timeline_date", locals: { audit: audit } %>
                              <p><%= audit.audited_changes["description"]&.html_safe if audit.audited_changes["description"].present? %></p>
                            </div>
                          <% end %>
                        <% elsif audit.auditable_type == "Consolidation" %>
                          <div class="col-2 mb-5">
                            <%= render partial: "/admin/comments/timeline_icon" %>
                          </div>
                          <div class="col-10 mb-5">
                            <%= render partial: "/admin/comments/timeline_date", locals: { audit: audit } %>
                            <p>
                              Consolidated shipment updated.<br>
                              <% consolidation.shipping_details.each do |sd| %>
                                <%= link_to sd.order.name + " (" + (get_shipping sd) + ")", edit_admin_order_path(sd.order) %><br>
                              <% end %>
                            </p>
                          </div>
                        <% end %>
                      <% end %>
                    </div>
                  </div>
                </div>
              </div>
            </td>
          </tr>
        <% end %>
      <% end %>
    </tbody>
  </table>
</div>
  
<% if @pagy.present? %>
  <% if @pagy.count > 1 %>
    <div id="page-nav">
      <%= render partial: "record_paginator", locals: { current_user: current_user } %>
    </div>
  <% end %>
<% end %>

<style>
  tr:hover .rounded-circle { border: solid 1px var(--blue); }
</style>