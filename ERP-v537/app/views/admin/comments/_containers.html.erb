<%= form_for [@container.comments.new], remote: true, :url => admin_container_comments_path(@container), data: {reflex: "submit->CommentReflex#submit", user_id: current_user.id, container_id: @container.id} do |f| %>
  <div class="row mb-3">
    <div class="col-9" data-reflex-permanent>
      <div id="editor"></div>
      <button type="submit" class="btn btn-primary mt-2">Add</button>
    </div>

    <div class="col-3">
      <%= f.hidden_field :description %>
    </div>
  </div>
<% end %>

<div class="timeline-container">
  <div class="row mx-0 mb-3 timeline timeline-line">
    <% Audit.where("auditable_type = ? AND associated_id = ? AND associated_type = ?", "Comment", @container.id, "Container").order(created_at: :desc).each do |audit| %>
      <% if audit.audited_changes["description"].present? %>
        <div class="col-2 mb-5">
          <%= render partial: "/admin/comments/timeline_icon" %>
        </div>
        <div class="col-10 mb-5">
          <%= render partial: "/admin/comments/timeline_date", locals: { audit: audit } %>
          <p><%= audit.audited_changes["description"]&.html_safe %></p>
        </div>
      <% end %>
    <% end %>
  </div>
</div>


<script type="text/javascript">
  $("#new_comment").on("submit", function() {
    $("#comment_description").val($(".ql-editor").html());

    var val = ",";
    $(this).find(".user-list .tag").each(function() {
      if ($(this).data("id") != null) {
        val += $(this).data("id") + ",";
      }
    });

    $("#comment_tag_user_id").val(val);
    $(".ql-editor").html("");
  });

  $(document).on("click", "#new_comment .user-search", function() {
    var id = $(this).data("id");
    var name = $(this).text().trim().toLowerCase().split(' ').join('_');
    var svg = '<%= show_svg("close.svg") %>'
    $("#new_comment .user-list").append("<span class='tag' data-id='" + id + "'>@" + name + "<span class='user-list-remove'>" + svg + "</span></span>");
    $(".comment-search").val("");
  });

  $(document).on("click", "#new_comment .department-search", function() {
    var id = $(this).data("id");
    var name = $(this).text().trim().toLowerCase().split(" ").join("_");
    var svg= '<%= show_svg("close.svg") %>'
    $("#new_comment .user-list").append("<span class='tag' data-id='d-" + id + "'>@" + name + "<span class='user-list-remove'>" + svg + "</span></span>");
    $(".comment-search").val("");
  });
</script>

<link href="//cdn.quilljs.com/1.0.0/quill.snow.css" rel="stylesheet" />

<script src="https://cdn.quilljs.com/1.0.0/quill.js"></script>

<script>
var toolbarOptions = [
  ['bold', 'italic', 'underline', 'strike'],
  [{ 'list': 'ordered'}, { 'list': 'bullet' }],
  [{ 'script': 'sub'}, { 'script': 'super' }]
];

  if (!$(".ql-toolbar").length) {
    var editor = new Quill("#editor", {
        
      modules: { 
        toolbar: toolbarOptions 
      },
      theme: "snow",
    });
  }
</script>