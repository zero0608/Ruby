<%- headers = ["Order Number", "Type", "Customer", "Order Date", "Amount", "Shipping Method", "ETC", "Days +/-", "Status"] -%>
<%= CSV.generate_line headers -%>
<%- @orders.each do |order| -%>
  <%- sum = 0 -%>
  <%- if order.line_items.present? -%>
    <%- order.line_items.where(order_from: nil).each_with_index do |item, i| -%>
      <%- sum = sum + mul(item.try(:price), item.try(:quantity)) -%>
    <%- end -%>
  <%- end -%>
  <%- if order.discount_codes.present? -%>
    <%- if order.discount_codes["discount_amount"].to_f.negative?() -%>
      <%- sum = sum + order.discount_codes["discount_amount"].to_f -%>
    <%- else -%>
      <%- sum = sum - order.discount_codes["discount_amount"].to_f -%>
    <%- end -%>
  <%- end -%>
  <%- if order.shipping_line.present? -%>
    <%- sum = sum + order.try(:shipping_line).try(:price).to_f -%>
  <%- end -%>
  <%- if order.tax_lines.present? -%>
    <%- sum = sum + order.tax_lines['price'].to_f -%>
  <%- end -%>
  <%- if order.refunds.present? && order.order_adjustments.present? -%>
    <%- order.refunds.each do |ref| -%>
      <%- order.order_adjustments.each do |adj| -%>
        <%- sum = sum + (adj.amount).to_f -%>
      <%- end -%>
    <%- end -%>
  <%- end -%>
  <%- days = 0 -%>
  <%- days_s = "" -%>
  <%- if order.eta.present? -%>
    <%- if (Date.today - order.eta).to_i > 0 -%>
      <%- days = (Date.today - order.eta + 1).to_i %>
      <%- days_s = "+" + (Date.today - order.eta + 1).to_i.to_s -%>
    <%- else -%>
      <%- days = (Date.today - order.eta).to_i -%>
      <%- days_s = (Date.today - order.eta).to_i.to_s -%>
    <%- end -%>
  <%- end -%>
  <%- status = "" -%>
  <%- if order.status == "in_progress" -%>
    <%- if order.shipping_details.all? {|ship| ship.status == 'shipped'} -%>
      <%- status = "Order Fulfilled" -%>
    <%- elsif order.shipping_details.any? {|ship| ship.status == 'shipped'} -%>
      <%- status = "Partial Shipped" -%>
    <%- else -%>
      <%- status = order.shipping_details.first.status.titleize -%>
    <%- end -%>
  <%- else -%>
    <%- status = order.status.titleize -%>
  <%- end -%>
  <%- if days >= params[:limit].to_i -%>
<%= CSV.generate_line([order.name, order.order_type, order&.customer&.full_name&.titleize, order.created_at, sum, order&.shipping_line&.title, order&.eta, days_s, status]) -%>
  <% end %>
<%- end -%>