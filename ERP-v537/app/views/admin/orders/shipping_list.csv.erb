<%- headers = ["Order Number", "Customer", (params[:ship_status] == "staging" ? "QS/MTO": "Shipping"), "SKU", "Order Date", "City/State", "ETC Date", "Shipping Method", "Order Amount", "Carrier", "Status", (params[:ship_status] == "ready_to_ship" ? "Days +/-" : "Printed")] -%>
<%= CSV.generate_line headers -%>
<%- if @shipping_details.present? -%>
  <%- @shipping_details.eager_load(:order).joins(:order).where(status: params[:ship_status]).where.not(orders: { order_type: "SW" }).each do |shipping_detail| -%>
    <%- k = "" -%>
    <%- if params[:ship_status] == "staging" -%>
      <%- k = shipping_detail.order&.kind_of_order -%>
    <%- else -%>
      <%- a = [] -%>
      <%- if shipping_detail.order.shipping_details.count >= 1 -%>
        <%- shipping_detail.order.shipping_details.each do |sh| -%>
          <%- a.push sh.id -%>
        <%- end -%>
        <%- k = "#{a.find_index(shipping_detail.id) + 1}" + "/" + "#{shipping_detail.order.shipping_details.count}" -%>  
      <%- else -%>
        <%- k = "Ship" -%>
      <%- end -%>
    <%- end -%>
    <%- l = shipping_detail.try(:line_items).pluck(:sku).try(:flatten).join(", ").upcase if shipping_detail.line_items.present? -%>
    <%- sm = "" -%>
    <%- if shipping_detail.order&.shipping_line&.title&.downcase&.include? "white glove" or shipping_detail.white_glove_delivery -%>
      <%- sm = "White Glove" -%>
    <%- elsif ["curbside", "contactless"].any? { |w| shipping_detail.order&.shipping_line&.title&.downcase&.include? w } -%>
      <%- sm = "Curbside" -%>
    <%- elsif shipping_detail.order&.shipping_line&.title&.downcase&.include? "admin shipping method - free" -%>
      <%- sm = "Admin - Free Ship" -%>
    <%- elsif shipping_detail.order&.shipping_line&.title&.downcase&.include? "local" -%>
      <%- sm = "Local Pickup" -%>
    <%- else -%>
      <%- sm = shipping_detail.order&.shipping_line&.title -%>
    <%- end -%>
    <%- sum = 0 -%>
    <%- if shipping_detail.order.line_items.present? -%>
      <%- shipping_detail.order.line_items.where(order_from: nil).each_with_index do |item, i| -%>
        <%- sum = sum + mul(item.try(:price), item.try(:quantity)) -%>
      <%- end -%>
    <%- end -%>
    <%- if shipping_detail.order.discount_codes.present? -%>
      <%- if shipping_detail.order.discount_codes["discount_amount"].to_f.negative?() -%>
        <%- sum = sum + shipping_detail.order.discount_codes["discount_amount"].to_f -%>
      <%- else -%>
        <%- sum = sum - shipping_detail.order.discount_codes["discount_amount"].to_f -%>
      <%- end -%>
    <%- end -%>
    <%- if shipping_detail.order.shipping_line.present? -%>
      <%- sum = sum + shipping_detail.order.try(:shipping_line).try(:price).to_f -%>
    <%- end -%>
    <%- if shipping_detail.order.tax_lines.present? -%>
      <%- sum = sum + shipping_detail.order.tax_lines['price'].to_f -%>
    <%- end -%>
    <%- if shipping_detail.order.refunds.present? && shipping_detail.order.order_adjustments.present? -%>
      <%- shipping_detail.order.refunds.each do |ref| -%>
        <%- shipping_detail.order.order_adjustments.each do |adj| -%>
          <%- sum = sum + (adj.amount).to_f -%>
        <%- end -%>
      <%- end -%>
    <%- end -%>
    <%- st = "" -%>
    <%- if shipping_detail.order&.status == "in_progress" -%>
      <%- ship = 0 -%>
      <%- shipping_detail.order.shipping_details.each do |s| -%>
        <%- if s.status == "shipped" -%>
          <%- ship = ship + 1 -%>
        <%- end -%>
      <%- end -%>
      <%- if ship > 0 && ship == shipping_detail.order.shipping_details.length -%>
        <%- st = "Order Fulfilled" -%>
      <%- elsif ship > 0 && ship < shipping_detail.order.shipping_details.length -%>
        <%- st = "Partial Shipped" -%>
      <%- else -%>
        <%- st = shipping_detail.order.shipping_details.first.status.titleize -%>
      <%- end -%>
    <%- else -%>
      <%- st = shipping_detail.order.try(:status).try(:titleize) -%>
    <%- end -%>
    <%- e = "" -%>
    <%- if params[:ship_status] == "ready_to_ship" -%>
      <%- if shipping_detail.order.eta.present? -%>
        <%- if (Date.today - shipping_detail.order.eta).to_i > 0 -%>
          <%- e = "+" + ((Date.today - shipping_detail.order.eta).to_i + 1).to_s -%>
        <%- else -%>
          <%- e = (Date.today - shipping_detail.order.eta).to_i.to_s -%>
        <%- end -%>
      <%- end -%>
    <%- else -%>
      <%- e = shipping_detail.printed_packing_slip ? "Printed" : "-" %>
    <%- end -%>
<%= CSV.generate_line([shipping_detail.order.name, shipping_detail.order&.customer&.full_name&.titleize, k, l, shipping_detail.order&.created_at.strftime("%B %d, %Y"), shipping_detail.order.shipping_address&.city.to_s + ", " + shipping_detail.order.shipping_address&.address2.to_s, shipping_detail&.order&.eta&.strftime("%B %d, %Y"), sm, number_to_currency(sum), Carrier.find_by(id: shipping_detail.carrier_id)&.name&.titleize, st.titleize, e]).html_safe -%>
  <%- end -%>
<%- end -%>